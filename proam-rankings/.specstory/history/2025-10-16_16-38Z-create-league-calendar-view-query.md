<!-- Generated by SpecStory -->

<!-- cursor Session 02882559-db1e-4563-9aeb-68010e444d82 (2025-10-16 16:38Z) -->

# Create league calendar view query (2025-10-16 16:38Z)

_**User (2025-10-16 16:13Z)**_

create view public.league_calendar as
with
  league_season_info as (
    select
      ls.id as season_id,
      ls.league_id,
      li.id as league_info_id,
      li.league as league_name,
      ls.season_number,
      ls.start_date,
      ls.end_date,
      ls.is_active,
      ls.year as game_year,
      li.lg_logo_url as league_logo,
      li.lg_url as league_website,
      li.lg_discord as discord_link,
      li.twitter_id,
      li.twitch_url
    from
      league_seasons ls
      join leagues_info li on ls.league_id = li.id
  ),
  league_tournaments as (
    select
      t.id as tournament_id,
      t.organizer_id as league_id,
      t.name as tournament_name,
      t.start_date,
      t.end_date,
      t.status,
      t.tier
    from
      tournaments t
    where
      t.organizer_id is not null
  ),
  league_matches as (
    select
      m.league_id,
      count(m.id) as total_matches,
      max(m.played_at) as last_match_date
    from
      matches m
    group by
      m.league_id
  ),
  upcoming_league_matches as (
    select
      um.league_id,
      count(um.id) as upcoming_matches_count,
      min(um.scheduled_at) as next_match_time
    from
      upcoming_matches um
    group by
      um.league_id
  ),
  league_champions as (
    select
      pc.league_id,
      pc.season,
      pc.team_id as champion_id,
      pc.team_name as champion_name,
      pc.champion_logo,
      pc.tournament_date,
      row_number() over (
        partition by
          pc.league_id,
          pc.season
        order by
          pc.tournament_date desc
      ) as rn
    from
      past_champions pc
    where
      pc.is_tournament = false
  )
select
  lsi.league_info_id as league_id,
  lsi.league_name,
  lsi.season_id,
  lsi.season_number,
  lsi.start_date,
  lsi.end_date,
  lsi.is_active,
  lsi.game_year,
  lsi.league_logo,
  lsi.league_website,
  lsi.discord_link,
  lsi.twitter_id,
  lsi.twitch_url,
  (
    select
      count(*) as count
    from
      league_tournaments lt
    where
      lt.league_id = lsi.league_id
  ) as tournament_count,
  COALESCE(lm.total_matches, 0::bigint) as total_matches,
  lm.last_match_date,
  COALESCE(ulm.upcoming_matches_count, 0::bigint) as upcoming_matches_count,
  ulm.next_match_time,
  lc.champion_id,
  lc.champion_name,
  lc.champion_logo,
  lc.tournament_date as championship_date,
  case
    when lsi.end_date < CURRENT_DATE then 'completed'::text
    when lsi.start_date > CURRENT_DATE then 'upcoming'::text
    when lsi.is_active = true then 'active'::text
    when lsi.start_date <= CURRENT_DATE
    and (
      lsi.end_date is null
      or lsi.end_date >= CURRENT_DATE
    ) then 'active'::text
    else 'unknown'::text
  end as league_status,
  case
    when lsi.end_date < CURRENT_DATE then 3
    when lsi.start_date > CURRENT_DATE then 1
    when lsi.is_active = true then 2
    when lsi.start_date <= CURRENT_DATE
    and (
      lsi.end_date is null
      or lsi.end_date >= CURRENT_DATE
    ) then 2
    else 4
  end as sort_order
from
  league_season_info lsi
  left join league_matches lm on lsi.league_id = lm.league_id
  left join upcoming_league_matches ulm on lsi.league_id = ulm.league_id
  left join league_champions lc on lsi.league_id = lc.league_id
  and lsi.season_number = lc.season
  and lc.rn = 1
order by
  (
    case
      when lsi.end_date < CURRENT_DATE then 3
      when lsi.start_date > CURRENT_DATE then 1
      when lsi.is_active = true then 2
      when lsi.start_date <= CURRENT_DATE
      and (
        lsi.end_date is null
        or lsi.end_date >= CURRENT_DATE
      ) then 2
      else 4
    end
  ),
  (COALESCE(lsi.is_active, false)) desc,
  (
    COALESCE(
      lsi.start_date,
      '2099-12-31'::date::timestamp with time zone
    )
  ),
  lsi.league_name,
  lsi.season_number desc;

this is adding all the games by league not by season

---

_**Assistant (default)**_

I'll help you fix the `league_calendar` view to properly group data by season rather than just by league. Let me first examine the current view and understand the database structure to identify the issue.


---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "How are league_seasons, leagues_info, and matches tables structured and related?" • **2** results</summary>
            
| File | Lines |
|------|-------|
| `src/lib/db.types.ts` | L6-18006 |
| `src/pages/leagues/[id].astro` | L60-114 |

</details>

---

Tool use: **grep**

<details>
<summary>Grep for "league_seasons|leagues_info|matches" in "src/lib/db.types.ts" • 252 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L102 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L144 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L280 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L737 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L856 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L1057 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L1092 |
| `src/lib/db.types.ts` | `group_matches: \{` | L1291 |
| `src/lib/db.types.ts` | `foreignKeyName: "group_matches_group_id_fkey"` | L1318 |
| `src/lib/db.types.ts` | `foreignKeyName: "group_matches_match_id_fkey"` | L1325 |
| `src/lib/db.types.ts` | `foreignKeyName: "group_matches_match_id_fkey"` | L1332 |
| `src/lib/db.types.ts` | `referencedRelation: "matches"` | L1335 |
| `src/lib/db.types.ts` | `foreignKeyName: "group_matches_match_id_fkey"` | L1339 |
| `src/lib/db.types.ts` | `referencedRelation: "v_matches_with_primary_context"` | L1342 |
| `src/lib/db.types.ts` | `matches_played: number \| null` | L1352 |
| `src/lib/db.types.ts` | `matches_played?: number \| null` | L1365 |
| `src/lib/db.types.ts` | `matches_played?: number \| null` | L1378 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L1846 |
| `src/lib/db.types.ts` | `league_open_matches: \{` | L1858 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_match_id_fkey"` | L1885 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_match_id_fkey"` | L1892 |
| `src/lib/db.types.ts` | `referencedRelation: "matches"` | L1895 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_match_id_fkey"` | L1899 |
| `src/lib/db.types.ts` | `referencedRelation: "v_matches_with_primary_context"` | L1902 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_season_id_fkey"` | L1906 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_season_id_fkey"` | L1913 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_season_id_fkey"` | L1920 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_season_id_fkey"` | L1927 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L1930 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_open_matches_season_id_fkey"` | L1934 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L2263 |
| `src/lib/db.types.ts` | `league_playoff_matches: \{` | L2275 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_match_id_fkey"` | L2302 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_match_id_fkey"` | L2309 |
| `src/lib/db.types.ts` | `referencedRelation: "matches"` | L2312 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_match_id_fkey"` | L2316 |
| `src/lib/db.types.ts` | `referencedRelation: "v_matches_with_primary_context"` | L2319 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_season_id_fkey"` | L2323 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_season_id_fkey"` | L2330 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_season_id_fkey"` | L2337 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_season_id_fkey"` | L2344 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L2347 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_playoff_matches_season_id_fkey"` | L2351 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L2438 |
| `src/lib/db.types.ts` | `league_seasons: \{` | L2450 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_id_fkey"` | L2495 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_id_fkey"` | L2502 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_id_fkey"` | L2509 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_id_fkey"` | L2516 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_id_fkey"` | L2523 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L2526 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_id_fkey"` | L2530 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2537 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2544 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2551 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2558 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2565 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L2568 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2572 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2579 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2586 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2593 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2600 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2607 |
| `src/lib/db.types.ts` | `foreignKeyName: "league_seasons_league_name_fkey"` | L2614 |
| `src/lib/db.types.ts` | `leagues_info: \{` | L2622 |
| `src/lib/db.types.ts` | `foreignKeyName: "leagues_info_sponsor_info_fkey"` | L2661 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L2733 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L2768 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L2890 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L2925 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L3001 |
| `src/lib/db.types.ts` | `referencedRelation: "matches"` | L3022 |
| `src/lib/db.types.ts` | `referencedRelation: "v_matches_with_primary_context"` | L3029 |
| `src/lib/db.types.ts` | `referencedRelation: "league_seasons"` | L3057 |
| `src/lib/db.types.ts` | `referencedRelation: "matches"` | L3157 |
| `src/lib/db.types.ts` | `referencedRelation: "v_matches_with_primary_context"` | L3164 |
| `src/lib/db.types.ts` | `referencedRelation: "matches"` | L3303 |
| `src/lib/db.types.ts` | `referencedRelation: "v_matches_with_primary_context"` | L3310 |
| `src/lib/db.types.ts` | `referencedRelation: "leagues_info"` | L3513 |


</details>

---

Tool use: **grep**

<details>
<summary>Grep for "league_seasons.*\{" in "src/lib/db.types.ts" • 1 match</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/lib/db.types.ts` | `league_seasons: \{` | L2450 |


</details>

---

Tool use: **grep**

<details>
<summary>Grep for "leagues_info.*\{" in "src/lib/db.types.ts" • 1 match</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/lib/db.types.ts` | `leagues_info: \{` | L2622 |


</details>

---

Tool use: **grep**

<details>
<summary>Grep for "matches.*\{" in "src/lib/db.types.ts" • 6 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/lib/db.types.ts` | `group_matches: \{` | L1291 |
| `src/lib/db.types.ts` | `league_open_matches: \{` | L1858 |
| `src/lib/db.types.ts` | `league_playoff_matches: \{` | L2275 |
| `src/lib/db.types.ts` | `matches: \{` | L4316 |
| `src/lib/db.types.ts` | `upcoming_matches: \{` | L10357 |
| `src/lib/db.types.ts` | `v_matches_with_primary_context: \{` | L15927 |


</details>

---

Now I understand the issue! Looking at the database structure, I can see that:

1. `matches` table has both `league_id` and `season_id` fields
2. The current view is grouping matches by `league_id` only, not by `season_id`
3. This causes all matches across all seasons for a league to be aggregated together

Let me create the corrected view that properly groups by season:


---

Tool use: **write**


<details><summary>Edit file: /Volumes/870SSD/Active GH Projects/proamrank-astro/proam-rankings/views/league_calendar_fixed.sql</summary>

**Chunk 1**
Lines added: 161, lines removed: 1

```diff
@@ -1,1 +1,161 @@
- 
+ -- Fixed league_calendar view that properly groups data by season, not just by league
+ create or replace view public.league_calendar as
+ with
+   league_season_info as (
+     select
+       ls.id as season_id,
+       ls.league_id,
+       li.id as league_info_id,
+       li.league as league_name,
+       ls.season_number,
+       ls.start_date,
+       ls.end_date,
+       ls.is_active,
+       ls.year as game_year,
+       li.lg_logo_url as league_logo,
+       li.lg_url as league_website,
+       li.lg_discord as discord_link,
+       li.twitter_id,
+       li.twitch_url
+     from
+       league_seasons ls
+       join leagues_info li on ls.league_id = li.id
+   ),
+   league_tournaments as (
+     select
+       t.id as tournament_id,
+       t.organizer_id as league_id,
+       t.name as tournament_name,
+       t.start_date,
+       t.end_date,
+       t.status,
+       t.tier
+     from
+       tournaments t
+     where
+       t.organizer_id is not null
+   ),
+   league_matches as (
+     select
+       m.season_id,  -- Group by season_id instead of league_id
+       count(m.id) as total_matches,
+       max(m.played_at) as last_match_date
+     from
+       matches m
+     where
+       m.season_id is not null  -- Only include matches with a season_id
+     group by
+       m.season_id
+   ),
+   upcoming_league_matches as (
+     select
+       um.league_id,
+       count(um.id) as upcoming_matches_count,
+       min(um.scheduled_at) as next_match_time
+     from
+       upcoming_matches um
+     group by
+       um.league_id
+   ),
+   league_champions as (
+     select
+       pc.league_id,
+       pc.season,
+       pc.team_id as champion_id,
+       pc.team_name as champion_name,
+       pc.champion_logo,
+       pc.tournament_date,
+       row_number() over (
+         partition by
+           pc.league_id,
+           pc.season
+         order by
+           pc.tournament_date desc
+       ) as rn
+     from
+       past_champions pc
+     where
+       pc.is_tournament = false
+   )
+ select
+   lsi.league_info_id as league_id,
+   lsi.league_name,
+   lsi.season_id,
+   lsi.season_number,
+   lsi.start_date,
+   lsi.end_date,
+   lsi.is_active,
+   lsi.game_year,
+   lsi.league_logo,
+   lsi.league_website,
+   lsi.discord_link,
+   lsi.twitter_id,
+   lsi.twitch_url,
+   (
+     select
+       count(*) as count
+     from
+       league_tournaments lt
+     where
+       lt.league_id = lsi.league_id
+   ) as tournament_count,
+   COALESCE(lm.total_matches, 0::bigint) as total_matches,
+   lm.last_match_date,
+   COALESCE(ulm.upcoming_matches_count, 0::bigint) as upcoming_matches_count,
+   ulm.next_match_time,
+   lc.champion_id,
+   lc.champion_name,
+   lc.champion_logo,
+   lc.tournament_date as championship_date,
+   case
+     when lsi.end_date < CURRENT_DATE then 'completed'::text
+     when lsi.start_date > CURRENT_DATE then 'upcoming'::text
+     when lsi.is_active = true then 'active'::text
+     when lsi.start_date <= CURRENT_DATE
+     and (
+       lsi.end_date is null
+       or lsi.end_date >= CURRENT_DATE
+     ) then 'active'::text
+     else 'unknown'::text
+   end as league_status,
+   case
+     when lsi.end_date < CURRENT_DATE then 3
+     when lsi.start_date > CURRENT_DATE then 1
+     when lsi.is_active = true then 2
+     when lsi.start_date <= CURRENT_DATE
+     and (
+       lsi.end_date is null
+       or lsi.end_date >= CURRENT_DATE
+     ) then 2
+     else 4
+   end as sort_order
+ from
+   league_season_info lsi
+   left join league_matches lm on lsi.season_id = lm.season_id  -- Join on season_id instead of league_id
+   left join upcoming_league_matches ulm on lsi.league_id = ulm.league_id
+   left join league_champions lc on lsi.league_id = lc.league_id
+   and lsi.season_number = lc.season
+   and lc.rn = 1
+ order by
+   (
+     case
+       when lsi.end_date < CURRENT_DATE then 3
+       when lsi.start_date > CURRENT_DATE then 1
+       when lsi.is_active = true then 2
+       when lsi.start_date <= CURRENT_DATE
+       and (
+         lsi.end_date is null
+         or lsi.end_date >= CURRENT_DATE
+       ) then 2
+       else 4
+     end
+   ),
+   (COALESCE(lsi.is_active, false)) desc,
+   (
+     COALESCE(
+       lsi.start_date,
+       '2099-12-31'::date::timestamp with time zone
+     )
+   ),
+   lsi.league_name,
+   lsi.season_number desc;
```

</details>

---

The key changes I made to fix the issue:

1. **Changed the `league_matches` CTE** to group by `season_id` instead of `league_id`:
   ```sql
   select
     m.season_id,  -- Changed from m.league_id
     count(m.id) as total_matches,
     max(m.played_at) as last_match_date
   from
     matches m
   where
     m.season_id is not null  -- Added filter to ensure we only count matches with seasons
   group by
     m.season_id  -- Changed from m.league_id
   ```

2. **Updated the JOIN condition** in the main query:
   ```sql
   left join league_matches lm on lsi.season_id = lm.season_id  -- Changed from league_id
   ```

3. **Added a filter** to only include matches that have a `season_id`, ensuring we don't count matches that aren't associated with a specific season.

Now the view will properly show match counts and statistics per season rather than aggregating all matches across all seasons for each league. Each season will have its own row with accurate match counts and statistics.

You can apply this fix by running the SQL file against your database:

```sql
-- Run this to replace the existing view
\i /path/to/league_calendar_fixed.sql
```

Or if you prefer to apply it directly to your database, you can copy the contents of the fixed view and execute it in your SQL client.

---


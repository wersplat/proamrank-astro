---
import { Image } from "astro:assets";
import BaseLayout from "../components/BaseLayout.astro";
import Navigation from "../components/Navigation.astro";
import RankTableIsland from "../components/RankTableIsland";
import MobileRankCard from "../components/MobileRankCard";
import ScrollToTop from "../components/ScrollToTop";
import UpcomingSpotlightBanner from "../components/UpcomingSpotlightBanner.astro";
import { supa } from "../lib/supabase";
import "../styles/global.css";

// Try team_analytics_mart first, fall back to teams table if mart is empty
let data, error;
const { data: martData, error: martError } = await supa((Astro.locals as any).runtime)
  .from("team_analytics_mart")
  .select(`
    team_id,
    team_name,
    logo_url,
    elo_rating,
    current_rp,
    rp_tier,
    wins,
    losses,
    win_percentage,
    games_played,
    is_active
  `)
  .gte("games_played", 1)
  .order("win_percentage", { ascending: false })
  .order("elo_rating", { ascending: false })
  .limit(100);

// If mart is empty or has error, fall back to teams table
if (!martData || martData.length === 0 || martError) {
  const { data: teamsData, error: teamsError } = await supa((Astro.locals as any).runtime)
    .from("teams")
    .select(`
      id,
      name,
      logo_url,
      elo_rating,
      current_rp,
      global_rank,
      leaderboard_tier,
      hybrid_score
    `)
    .eq("is_active", true)
    .order("hybrid_score", { ascending: false })
    .limit(100);
  
  data = teamsData;
  error = teamsError;
} else {
  data = martData;
  error = martError;
}

if (error) console.error(error);

// Map to expected format (maintaining compatibility with existing component)
const rows = (data ?? []).map((team: any) => ({
  team_id: team.team_id || team.id,
  team_name: team.team_name || team.name,
  logo_url: team.logo_url,
  elo_rating: team.elo_rating,
  current_rp: team.current_rp,
  global_rank: team.global_rank || null,
  leaderboard_tier: team.rp_tier || team.leaderboard_tier,
  hybrid_score: team.hybrid_score || Math.round((team.win_percentage || 0) * 10 + (team.elo_rating || 1500) / 10),
  win_percentage: team.win_percentage || null,
  games_played: team.games_played || null,
  is_active: team.is_active !== undefined ? team.is_active : true, // Default to true if not in data
}));

// Get hot teams (high win percentage with at least 5 games played, or teams in top 10)
// Only include active teams
const hotTeams = [...rows]
  .filter((team: any) => {
    // Only show active teams
    if (team.is_active === false) return false;
    
    const hasGoodRecord = team.games_played && team.games_played >= 5 && team.win_percentage && team.win_percentage >= 60;
    const isTopTeam = team.global_rank && team.global_rank <= 10;
    return hasGoodRecord || isTopTeam;
  })
  .sort((a: any, b: any) => {
    // Sort by win percentage if available, otherwise by hybrid score
    if (a.win_percentage && b.win_percentage) {
      return b.win_percentage - a.win_percentage;
    }
    return (b.hybrid_score ?? 0) - (a.hybrid_score ?? 0);
  })
  .slice(0, 6); // Top 6 hot teams
---

<BaseLayout 
  title="Home"
  description="Comprehensive global rankings and analytics for NBA 2K Pro-Am competitive teams and players"
  ogImage="/GR.svg"
  ogType="website"
/>
  <Navigation />
  <main id="main-content" class="mx-auto max-w-6xl p-6 grade-pattern" role="main">
    <UpcomingSpotlightBanner />
    <div class="mb-6">
      <h1 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">NBA 2K Pro-Am Global Team Rankings</h1>
      <p class="text-gray-600 dark:text-neutral-400 mb-4">
        Explore the comprehensive NBA 2K Pro-Am Global Team Rankings featuring top competitive teams, 
        real-time statistics, and performance analytics. Track team standings, ELO ratings, and ranking 
        points across all major leagues and tournaments.
      </p>
    </div>

    <!-- Hot Teams Rising Section -->
    {hotTeams.length > 0 && (
      <section class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <span class="text-2xl">ðŸ”¥</span>
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Hot Teams Rising</h2>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
          {hotTeams.map((team: typeof rows[0]) => (
            <a 
              href={`/teams/${team.team_id}`}
              class="block p-3 rounded-lg border border-gray-200 dark:border-patriot-blue-800 bg-white dark:bg-patriot-blue-900/30 hover:border-patriot-red-500 dark:hover:border-patriot-red-500 hover:bg-gray-50 dark:hover:bg-patriot-blue-900/50 transition-all duration-200 group"
            >
              <div class="flex flex-col items-center text-center">
                {team.logo_url ? (
                  <img 
                    src={team.logo_url}
                    alt=""
                    class="h-12 w-12 rounded object-cover mb-2 ring-2 ring-gray-300 dark:ring-patriot-blue-800 group-hover:ring-patriot-red-500 transition"
                    loading="lazy"
                    decoding="async"
                  />
                ) : (
                  <div class="h-12 w-12 rounded bg-gray-200 dark:bg-patriot-blue-800 flex items-center justify-center text-gray-700 dark:text-neutral-300 text-xs font-bold mb-2 ring-2 ring-gray-300 dark:ring-patriot-blue-800 group-hover:ring-patriot-red-500 transition">
                    {team.team_name?.substring(0, 2).toUpperCase() || '??'}
                  </div>
                )}
                <div class="font-semibold text-sm truncate w-full mb-1 text-gray-900 dark:text-white">{team.team_name}</div>
                {team.win_percentage !== null && (
                  <div class="text-xs text-patriot-red-600 dark:text-patriot-red-400 font-medium">
                    {team.win_percentage.toFixed(1)}% Win Rate
                  </div>
                )}
                {team.global_rank && (
                  <div class="text-xs text-gray-600 dark:text-neutral-400 mt-1">Rank #{team.global_rank}</div>
                )}
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- CTA Banner -->
    <div class="mb-6 p-4 rounded-lg bg-gradient-to-r from-patriot-red-600/20 via-patriot-blue-600/20 to-patriot-red-600/20 border border-patriot-red-500/30 hover:border-patriot-red-500/50 transition">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div>
          <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white">Want to understand our ranking system?</h3>
          <p class="text-sm text-gray-700 dark:text-neutral-300">Learn how teams are ranked using our Hybrid Score system</p>
        </div>
        <a 
          href="/ranking-system" 
          class="px-4 py-2 bg-patriot-red-600 hover:bg-patriot-red-700 text-white rounded-md font-medium transition whitespace-nowrap"
        >
          View Rankings Formula
        </a>
      </div>
    </div>

    <!-- Mobile cards (smaller screens) -->
    <section class="space-y-3 sm:hidden">
      <MobileRankCard client:load rows={rows} />
    </section>

    <!-- Desktop table (hydrated island, optional) -->
    <RankTableIsland client:idle rows={rows} />
    
    <!-- Scroll to top button -->
    <ScrollToTop client:load />
  </main>
</BaseLayout>

---
import BaseLayout from "../components/BaseLayout.astro";
import Navigation from "../components/Navigation.astro";
import RankTableIsland from "../components/RankTableIsland";
import UpcomingSpotlightBanner from "../components/UpcomingSpotlightBanner.astro";
import { supa } from "../lib/supabase";
import "../styles/global.css";

// Try team_analytics_mart first, fall back to teams table if mart is empty
let data, error;
const { data: martData, error: martError } = await supa((Astro.locals as any).runtime)
  .from("team_analytics_mart")
  .select(`
    team_id,
    team_name,
    logo_url,
    elo_rating,
    current_rp,
    rp_tier,
    wins,
    losses,
    win_percentage,
    games_played
  `)
  .gte("games_played", 1)
  .order("win_percentage", { ascending: false })
  .order("elo_rating", { ascending: false })
  .limit(100);

// If mart is empty or has error, fall back to teams table
if (!martData || martData.length === 0 || martError) {
  const { data: teamsData, error: teamsError } = await supa((Astro.locals as any).runtime)
    .from("teams")
    .select(`
      id,
      name,
      logo_url,
      elo_rating,
      current_rp,
      global_rank,
      leaderboard_tier,
      hybrid_score
    `)
    .eq("is_active", true)
    .order("hybrid_score", { ascending: false })
    .limit(100);
  
  data = teamsData;
  error = teamsError;
} else {
  data = martData;
  error = martError;
}

if (error) console.error(error);

// Map to expected format (maintaining compatibility with existing component)
const rows = (data ?? []).map((team: any) => ({
  team_id: team.team_id || team.id,
  team_name: team.team_name || team.name,
  logo_url: team.logo_url,
  elo_rating: team.elo_rating,
  current_rp: team.current_rp,
  global_rank: team.global_rank || null,
  leaderboard_tier: team.rp_tier || team.leaderboard_tier,
  hybrid_score: team.hybrid_score || Math.round((team.win_percentage || 0) * 10 + (team.elo_rating || 1500) / 10),
}));
---

<BaseLayout 
  title="Home"
  description="Comprehensive global rankings and analytics for NBA 2K Pro-Am competitive teams and players"
>
  <Navigation />
  <main class="mx-auto max-w-6xl p-6">
    <UpcomingSpotlightBanner />
    <div class="mb-6">
      <h1 class="text-2xl font-bold mb-4">NBA 2K Pro-Am Global Team Rankings</h1>
      <p class="text-neutral-400 mb-4">
        Explore the comprehensive NBA 2K Pro-Am Global Team Rankings featuring top competitive teams, 
        real-time statistics, and performance analytics. Track team standings, ELO ratings, and ranking 
        points across all major leagues and tournaments.
      </p>
    </div>

      <!-- Mobile cards (smaller screens) -->
      <section class="space-y-2 sm:hidden">
        {rows.map((r: typeof rows[0]) => (
          <article class="rounded border border-patriot-blue-800 p-3">
            <header class="flex items-center gap-3">
              {r.logo_url ? (
                <img src={r.logo_url}
                   alt="" class="h-8 w-8 rounded object-cover" loading="lazy" />
              ) : (
                <div class="h-8 w-8 rounded bg-patriot-blue-800 flex items-center justify-center text-neutral-400 text-[10px] font-bold">
                  {r.team_name?.substring(0, 2).toUpperCase() || '??'}
                </div>
              )}
              <div class="font-semibold">{r.team_name}</div>
              {r.leaderboard_tier && (
                <div class="ml-auto text-xs font-bold text-neutral-400">{r.leaderboard_tier}</div>
              )}
            </header>
            <dl class="mt-2 grid grid-cols-3 text-sm">
              <div><dt class="text-neutral-400">Score</dt><dd class="font-medium">{Math.round(r.hybrid_score ?? 0)}</dd></div>
              <div><dt class="text-neutral-400">Elo</dt><dd class="font-medium">{Math.round(r.elo_rating ?? 1500)}</dd></div>
              <div><dt class="text-neutral-400">RP</dt><dd>{r.current_rp ?? 0}</dd></div>
            </dl>
          </article>
        ))}
      </section>

    <!-- Desktop table (hydrated island, optional) -->
    <RankTableIsland client:idle rows={rows} />
  </main>
</BaseLayout>

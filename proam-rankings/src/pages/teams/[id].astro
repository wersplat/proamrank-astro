---
import BaseLayout from "../../components/BaseLayout.astro";
import Navigation from "../../components/Navigation.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import TeamTabsIsland from "../../components/TeamTabsIsland";
import { supa } from "../../lib/supabase";
import { generateThemeCSSVars } from "../../lib/theme";
import "../../styles/global.css";

// Enable SSR for dynamic team pages
export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/teams");
}

// Use team_analytics_mart for optimized team data
const { data: teamData } = await supa((Astro.locals as any).runtime)
  .from("team_analytics_mart")
  .select("*")
  .eq("team_id", id)
  .maybeSingle();

// Get team momentum and form data from team_momentum_indicators_mart
const { data: momentumData } = await supa((Astro.locals as any).runtime)
  .from("team_momentum_indicators_mart")
  .select("*")
  .eq("team_id", id)
  .maybeSingle();

// Get roster analysis from roster_value_comparison_mart
const { data: rosterData } = await supa((Astro.locals as any).runtime)
  .from("roster_value_comparison_mart")
  .select("*")
  .eq("team_id", id)
  .maybeSingle();

// Map team_analytics_mart data to expected format
const perfData = teamData ? {
  team_id: teamData.team_id,
  elo_rating: teamData.elo_rating,
  current_rp: teamData.current_rp,
  win_percentage: teamData.win_percentage,
  matches_won: teamData.wins,
  matches_lost: teamData.losses,
} : null;

// Get current roster
const { data: roster } = await supa((Astro.locals as any).runtime)
  .from("team_roster_current")
  .select("*")
  .eq("team_id", id)
  .order("is_captain", { ascending: false });

// Get all matches for the team
const { data: matchesData } = await supa((Astro.locals as any).runtime)
  .from("v_matches_with_primary_context")
  .select("id, played_at, team_a_id, team_b_id, score_a, score_b, winner_id, boxscore_url, status, verified, league_id, season_id, tournament_id, stage")
  .or(`team_a_id.eq.${id},team_b_id.eq.${id}`)
  .order("played_at", { ascending: false });

// Get team info for matches
const matchTeamIds = Array.from(new Set([
  ...(matchesData ?? []).map((m: any) => m.team_a_id),
  ...(matchesData ?? []).map((m: any) => m.team_b_id)
].filter((tid: string) => tid !== id)));

const { data: matchTeamsData } = matchTeamIds.length > 0 ? await supa((Astro.locals as any).runtime)
  .from("teams")
  .select("id, name, logo_url")
  .in("id", matchTeamIds) : { data: [] };

const matchTeamMap = new Map((matchTeamsData ?? []).map((t: any) => [t.id, t]));

// Get league info for matches (use season_id for accurate season lookup)
const matchSeasonIds = Array.from(new Set((matchesData ?? []).map((m: any) => m.season_id).filter(Boolean)));
const { data: matchLeaguesData } = matchSeasonIds.length > 0 ? await supa((Astro.locals as any).runtime)
  .from("league_calendar")
  .select("season_id, league_id, league_name, season_number")
  .in("season_id", matchSeasonIds) : { data: [] };

const matchLeagueMap = new Map((matchLeaguesData ?? []).map((l: any) => [l.season_id, l]));

// Get tournament info for matches
const matchTournamentIds = Array.from(new Set((matchesData ?? []).map((m: any) => m.tournament_id).filter(Boolean)));
const { data: matchTournamentsData } = matchTournamentIds.length > 0 ? await supa((Astro.locals as any).runtime)
  .from("tournaments")
  .select("id, name")
  .in("id", matchTournamentIds) : { data: [] };

const matchTournamentMap = new Map((matchTournamentsData ?? []).map((t: any) => [t.id, t]));

const matches = (matchesData ?? []).map((m: any) => ({
  ...m,
  team_a: m.team_a_id === id ? { name: teamData?.name, logo_url: teamData?.logo_url } : matchTeamMap.get(m.team_a_id),
  team_b: m.team_b_id === id ? { name: teamData?.name, logo_url: teamData?.logo_url } : matchTeamMap.get(m.team_b_id),
  league: matchLeagueMap.get(m.season_id),
  tournament: matchTournamentMap.get(m.tournament_id),
}));

// Get team roster history
const { data: teamHistory } = await supa((Astro.locals as any).runtime)
  .from("team_roster_history")
  .select("player_id, gamertag, position, joined_at, left_at, season_number, league_name, team_logo, team_name, is_captain, is_player_coach, tournament_id, tournament_name")
  .eq("team_id", id)
  .order("joined_at", { ascending: false });

// Get past championships
const { data: championships } = await supa((Astro.locals as any).runtime)
  .from("past_champions")
  .select("*")
  .eq("team_id", id)
  .order("year", { ascending: false });

// Get year-by-year team stats
const { data: yearStats } = await supa((Astro.locals as any).runtime)
  .from("team_performance_by_game_year")
  .select("*")
  .eq("team_id", id)
  .order("game_year", { ascending: false });

// Fetch global_rank and theme colors from teams table since it's not in the mart
let globalRank = null;
let hybridScore = null;
let teamThemeColors: any = null;
if (teamData) {
  const { data: rankData } = await supa((Astro.locals as any).runtime)
    .from("teams")
    .select("global_rank, hybrid_score, color_primary, color_secondary, color_accent")
    .eq("id", id)
    .maybeSingle();
  
  globalRank = rankData?.global_rank;
  hybridScore = rankData?.hybrid_score;
  if (rankData) {
    teamThemeColors = {
      color_primary: rankData.color_primary,
      color_secondary: rankData.color_secondary,
      color_accent: rankData.color_accent,
    };
  }
}

// Generate CSS variables for team theme
const teamThemeCSS = generateThemeCSSVars(teamThemeColors, 'team');

// Map to expected format for template compatibility
const team = teamData ? {
  id: teamData.team_id,
  name: teamData.team_name,
  logo_url: teamData.logo_url,
  global_rank: globalRank,
  current_rp: teamData.current_rp,
  elo_rating: teamData.elo_rating,
  hybrid_score: hybridScore,
  leaderboard_tier: teamData.rp_tier,
} : null;

const performance = perfData;
const players = roster ?? [];
const allMatches = matches;
const momentum = momentumData;
const rosterAnalysis = rosterData;

if (!team) {
  return Astro.redirect("/teams");
}

const teamDescription = `View ${team.name}'s profile, roster, match history, and statistics. Track team performance, rankings, and achievements in NBA 2K Pro-Am competitions.`;

// Construct Open Graph image URL
const ogImage = team.logo_url || "/GR.svg";
const ogUrl = Astro.url.href;

// Structured data for team
const teamStructuredData = {
  "@context": "https://schema.org",
  "@type": "SportsTeam",
  "name": team.name,
  "description": teamDescription,
  "url": ogUrl,
  "logo": team.logo_url ? (team.logo_url.startsWith('http') ? team.logo_url : `${Astro.url.origin}${team.logo_url}`) : `${Astro.url.origin}/GR.svg`,
  "sport": "Basketball",
  "identifier": team.id,
  ...(team.global_rank && {
    "ranking": {
      "@type": "ItemList",
      "position": team.global_rank
    }
  })
};

// Breadcrumb structured data
const breadcrumbStructuredData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.url.origin
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Teams",
      "item": `${Astro.url.origin}/teams`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": team.name,
      "item": ogUrl
    }
  ]
};
---

<BaseLayout 
  title={team.name}
  description={teamDescription}
  ogImage={ogImage}
  ogType="website"
  ogUrl={ogUrl}
/>
  <script type="application/ld+json" set:html={JSON.stringify(teamStructuredData)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbStructuredData)} />
  <Navigation />
    <main class="mx-auto max-w-6xl p-6 grade-pattern">
      <Breadcrumbs items={[
        { label: "Home", href: "/" },
        { label: "Teams", href: "/teams" },
        { label: team.name, href: `/teams/${team.id}` }
      ]} />
      <!-- Team Header -->
      <div class="mb-8 flex items-start gap-6">
        {team.logo_url ? (
          <img 
            src={team.logo_url}
            alt={team.name || "Team"}
            class="h-24 w-24 rounded-lg object-cover"
          />
        ) : (
          <div class="h-24 w-24 rounded-lg bg-neutral-800 flex items-center justify-center text-neutral-400 text-2xl font-bold">
            {team.name?.substring(0, 2).toUpperCase() || '??'}
          </div>
        )}
        <div class="flex-1">
          <h1 class="text-3xl font-bold mb-2">{team.name}</h1>
          <div class="flex flex-wrap gap-4 text-sm">
            <div>
              <span class="text-neutral-400">Global Rank:</span>
              <span class="ml-2 font-semibold">#{team.global_rank ?? '-'}</span>
            </div>
            <div>
              <span class="text-neutral-400">Hybrid Score:</span>
              <span class="ml-2 font-semibold">{Math.round(team.hybrid_score ?? 0)}</span>
            </div>
            <div>
              <span class="text-neutral-400">Tier:</span>
              <span class="ml-2 font-semibold">{team.leaderboard_tier || '-'}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <div class="rounded-lg border border-neutral-800 p-4">
          <div class="text-neutral-400 text-sm mb-1">Elo Rating</div>
          <div class="text-2xl font-bold">{Math.round(performance?.elo_rating ?? team.elo_rating ?? 1500)}</div>
        </div>
        <div class="rounded-lg border border-neutral-800 p-4">
          <div class="text-neutral-400 text-sm mb-1">Ranking Points</div>
          <div class="text-2xl font-bold">{performance?.current_rp ?? team.current_rp ?? 0}</div>
        </div>
        <div class="rounded-lg border border-neutral-800 p-4">
          <div class="text-neutral-400 text-sm mb-1">Win Rate</div>
          <div class="text-2xl font-bold">
            {performance?.win_percentage 
              ? `${Number(performance.win_percentage).toFixed(1)}%` 
              : '-'}
          </div>
        </div>
        <div class="rounded-lg border border-neutral-800 p-4">
          <div class="text-neutral-400 text-sm mb-1">Record</div>
          <div class="text-2xl font-bold">
            {performance?.matches_won ?? 0}-{performance?.matches_lost ?? 0}
          </div>
        </div>
      </div>

      <!-- Verification Info Notice -->
      <div class="mb-6 p-4 rounded-lg border border-blue-500/30 bg-blue-900/10">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          <div class="flex-1">
            <h3 class="text-sm font-semibold text-blue-300 mb-1">About Match Verification</h3>
            <p class="text-sm text-neutral-300">
              Unless a match has the <span class="text-green-300 font-medium">Verified</span> badge, stats were derived from OCR (Optical Character Recognition) and may contain errors. 
              Only verified stats are entered into our statistics tables and affect player ratings. 
              <a href="/ranking-system#verification" class="text-blue-400 hover:text-blue-300 underline">Learn more</a>
            </p>
          </div>
        </div>
      </div>

      <!-- Team Tabs (Roster, Matches, History) -->
      <section>
        <TeamTabsIsland 
          client:load
          teamId={id as string}
          players={players as any}
          matches={allMatches as any}
          teamHistory={teamHistory ?? [] as any}
          championships={championships ?? [] as any}
          yearStats={yearStats ?? [] as any}
        />
      </section>
    </main>
</BaseLayout>

